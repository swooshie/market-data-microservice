name: CI

on: [push, pull_request]

jobs:
  test-lint-build:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: market_data
        ports: [5432:5432]
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      zookeeper:
        image: confluentinc/cp-zookeeper:7.4.0
        ports: [2181:2181]
        options: >-
          --health-cmd "echo ruok | nc localhost 2181 | grep imok"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      kafka:
        image: confluentinc/cp-kafka:7.4.0
        env:
          KAFKA_BROKER_ID: 1
          KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
          KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
          KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
        ports: [9092:9092]
        options: >-
          --health-cmd "cub kafka-ready -b localhost:9092 1 10"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        depends_on:
          - zookeeper

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio flake8 httpx

      - name: Lint
        run: flake8 app

      - name: Tests
        run: pytest -q

      - name: Build Docker image
        run: docker build -t market-data-service:ci .